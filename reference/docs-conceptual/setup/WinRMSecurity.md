---
ms.date: 06/05/2017
keywords: rutiny prostředí PowerShell
title: WinRMSecurity
ms.openlocfilehash: 43e77067e301cdf1b792cb0d24b72ee0abb3349a
ms.sourcegitcommit: 01d6985ed190a222e9da1da41596f524f607a5bc
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 06/07/2018
ms.locfileid: "34482943"
---
# <a name="powershell-remoting-security-considerations"></a><span data-ttu-id="ce8ba-103">Důležité informace o zabezpečení pro vzdálenou komunikaci prostředí PowerShell</span><span class="sxs-lookup"><span data-stu-id="ce8ba-103">PowerShell Remoting Security Considerations</span></span>

<span data-ttu-id="ce8ba-104">Vzdálená komunikace prostředí PowerShell je doporučeným způsobem, jak spravovat systémy Windows.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-104">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="ce8ba-105">Ve výchozím nastavení v systému Windows Server 2012 R2 je povolena vzdálená komunikace prostředí PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-105">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="ce8ba-106">Tento dokument popisuje aspekty zabezpečení, doporučení a osvědčené postupy při použití vzdálenou komunikaci prostředí PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-106">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="ce8ba-107">Co je Vzdálená komunikace prostředí PowerShell?</span><span class="sxs-lookup"><span data-stu-id="ce8ba-107">What is PowerShell Remoting?</span></span>

<span data-ttu-id="ce8ba-108">Používá vzdálenou komunikaci prostředí PowerShell [Vzdálená správa systému Windows (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426.aspx), což je implementaci společnosti Microsoft [webové služby pro správu (WS-Management)](http://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protokol, aby uživatelé mohli spustit prostředí PowerShell příkazy na vzdálených počítačích.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-108">PowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426.aspx), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](http://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="ce8ba-109">Můžete najít další informace o používání vzdálenou komunikaci prostředí PowerShell v [spuštění vzdálené příkazy](https://technet.microsoft.com/library/dd819505.aspx).</span><span class="sxs-lookup"><span data-stu-id="ce8ba-109">You can find more information about using PowerShell Remoting at [Running Remote Commands](https://technet.microsoft.com/library/dd819505.aspx).</span></span>

<span data-ttu-id="ce8ba-110">Vzdálená komunikace prostředí PowerShell není stejná jako **ComputerName** parametru rutiny ji spustit na vzdáleném počítači, který používá vzdálené volání procedur (RPC) jako jeho základního protokolu.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-110">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="ce8ba-111">Výchozí nastavení vzdálenou komunikaci prostředí PowerShell</span><span class="sxs-lookup"><span data-stu-id="ce8ba-111">PowerShell Remoting default settings</span></span>

<span data-ttu-id="ce8ba-112">Vzdálená komunikace prostředí PowerShell (a WinRM) naslouchat na následující porty:</span><span class="sxs-lookup"><span data-stu-id="ce8ba-112">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="ce8ba-113">HTTP: 5985</span><span class="sxs-lookup"><span data-stu-id="ce8ba-113">HTTP: 5985</span></span>
- <span data-ttu-id="ce8ba-114">HTTPS: 5986</span><span class="sxs-lookup"><span data-stu-id="ce8ba-114">HTTPS: 5986</span></span>

<span data-ttu-id="ce8ba-115">Ve výchozím nastavení umožňuje vzdálenou komunikaci prostředí PowerShell připojení pouze z členy skupiny Administrators.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-115">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span> <span data-ttu-id="ce8ba-116">Relace se spustí v kontextu uživatele, tak, aby všechny řízení přístupu operačního systému použít pro jednotlivé uživatele a skupiny nadále platí pro ně během připojení přes vzdálenou komunikaci prostředí PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-116">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="ce8ba-117">Výchozí pravidlo brány Windows Firewall pro vzdálenou komunikaci prostředí PowerShell v privátní síti, přijme všechna připojení.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-117">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="ce8ba-118">Výchozí pravidlo brány Windows Firewall na veřejných sítích, umožňuje vzdálenou komunikaci prostředí PowerShell připojení pouze z ve stejné podsíti.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-118">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="ce8ba-119">Budete muset explicitně změnit daného pravidla otevřít vzdálenou komunikaci prostředí PowerShell pro všechna připojení ve veřejné síti.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-119">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

><span data-ttu-id="ce8ba-120">**Upozornění:** pravidlo brány firewall pro veřejné sítě je určená k ochraně počítače z pokusy o potenciálně škodlivého externí připojení.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-120">**Warning:** The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="ce8ba-121">Buďte opatrní při odebírání toto pravidlo.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-121">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="ce8ba-122">Proces izolace</span><span class="sxs-lookup"><span data-stu-id="ce8ba-122">Process isolation</span></span>

<span data-ttu-id="ce8ba-123">Používá vzdálenou komunikaci prostředí PowerShell [Vzdálená správa systému Windows (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426) pro komunikaci mezi počítači.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-123">PowerShell Remoting uses [Windows Remote Management (WinRM)](https://msdn.microsoft.com/library/windows/desktop/aa384426) for communication between computers.</span></span>
<span data-ttu-id="ce8ba-124">WinRM spuštěn jako služba pod účtem Network Service a vytvoří izolovaných procesech systémem jako uživatelské účty do instance hostitele prostředí PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-124">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="ce8ba-125">Instance prostředí PowerShell spuštěna jako jeden uživatel nemá přístup k procesu spuštěného instance prostředí PowerShell jako jiný uživatel.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-125">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="ce8ba-126">Protokoly událostí generovaných vzdálenou komunikaci prostředí PowerShell</span><span class="sxs-lookup"><span data-stu-id="ce8ba-126">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="ce8ba-127">FireEye poskytl dobrý souhrn protokoly událostí a dalších zabezpečení důkaz generované vzdálenou komunikaci prostředí PowerShell relace, která je k dispozici na [příčin útoků prostředí PowerShell](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span><span class="sxs-lookup"><span data-stu-id="ce8ba-127">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="ce8ba-128">Šifrování a přenosu protokolů</span><span class="sxs-lookup"><span data-stu-id="ce8ba-128">Encryption and transport protocols</span></span>

<span data-ttu-id="ce8ba-129">Je vhodné zvážit zabezpečení připojení vzdálenou komunikaci prostředí PowerShell za dvou hledisek: počáteční ověřování a nepřetržitě komunikují.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-129">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="ce8ba-130">Bez ohledu na přenos protokol použitý (HTTP nebo HTTPS) vzdálenou komunikaci prostředí PowerShell vždy šifruje veškerou komunikaci po počáteční ověřování symetrickým klíčem relace AES 256.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-130">Regardless of the transport protocol used (HTTP or HTTPS), PowerShell Remoting always encrypts all communication after initial authentication with a per-session AES-256 symmetric key.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="ce8ba-131">Počáteční ověřování</span><span class="sxs-lookup"><span data-stu-id="ce8ba-131">Initial authentication</span></span>

<span data-ttu-id="ce8ba-132">Ověřování potvrdí identitu klienta a serveru – v ideálním případě - serveru do klienta.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-132">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="ce8ba-133">Pokud se klient připojí k doméně serveru pomocí názvu počítače (tj: server01, nebo server01.contoso.com), je výchozím ověřovacím protokolem [Kerberos](https://msdn.microsoft.com/library/windows/desktop/aa378747.aspx).</span><span class="sxs-lookup"><span data-stu-id="ce8ba-133">When a client connects to a domain server using its computer name (i.e.: server01, or server01.contoso.com), the default authentication protocol is [Kerberos](https://msdn.microsoft.com/library/windows/desktop/aa378747.aspx).</span></span>
<span data-ttu-id="ce8ba-134">Protokol Kerberos zaručuje identity uživatele i identitu serveru bez odeslání žádné řazení opakovaně použitelné přihlašovacích údajů.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-134">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="ce8ba-135">Pokud se klient připojuje k serveru domény pomocí jeho IP adresy nebo připojuje k serveru pracovní skupiny, není možné ověřování pomocí protokolu Kerberos.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-135">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="ce8ba-136">V takovém případě vzdálenou komunikaci prostředí PowerShell spoléhá na [ověřovací protokol NTLM](https://msdn.microsoft.com/library/windows/desktop/aa378749.aspx).</span><span class="sxs-lookup"><span data-stu-id="ce8ba-136">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](https://msdn.microsoft.com/library/windows/desktop/aa378749.aspx).</span></span> <span data-ttu-id="ce8ba-137">Ověřovací protokol NTLM zaručuje bez odeslání žádné řazení přidělitelný přihlašovací údaje identity uživatele.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-137">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="ce8ba-138">K prokázání identity uživatele, protokol NTLM vyžaduje, že klient i server výpočetní klíče relace z hesla uživatele bez někdy výměna heslo samotné.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-138">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="ce8ba-139">Server obvykle neví heslo uživatele, takže komunikuje s řadiči domény, který znát heslo uživatele a vypočítá klíče relace pro server.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-139">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="ce8ba-140">Protokol NTLM, ale nezaručí identitu serveru.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-140">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="ce8ba-141">Stejně jako u všechny protokoly pro ověřování používat protokol NTLM, může útočník má přístup k účtu počítače připojené k doméně počítače vyvolání řadiče domény výpočetní NTLM-klíčem relace a zosobnit serveru.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-141">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="ce8ba-142">Ověřování pomocí protokolu NTLM je ve výchozím nastavení zakázané, ale může být buď konfiguraci protokolu SSL na cílovém serveru nebo konfigurace nastavení WinRM TrustedHosts na straně klienta povoleno.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-142">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="ce8ba-143">Používání certifikátů SSL k ověření identity serveru během připojení pomocí protokolu NTLM</span><span class="sxs-lookup"><span data-stu-id="ce8ba-143">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="ce8ba-144">Vzhledem k tomu, že ověřovací protokol NTLM, nebude moct zajistit identity cílového serveru (pouze to, že zná již vaše heslo), můžete nakonfigurovat cílové servery používat protokol SSL pro vzdálenou komunikaci prostředí PowerShell.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-144">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span> <span data-ttu-id="ce8ba-145">Přiřazení certifikát SSL k cílovému serveru (Pokud je vydaný certifikační autoritou, která klient také důvěřuje) umožňuje ověření protokolem NTLM, která zaručí identity uživatele i identitu serveru.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-145">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="ce8ba-146">Ignorování chyb identita serveru na základě protokolu NTLM</span><span class="sxs-lookup"><span data-stu-id="ce8ba-146">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="ce8ba-147">Pokud nasazení certifikát SSL k serveru pro připojení protokolu NTLM je nemožné, může potlačit výsledné chyby identity přidáním serveru do služby WinRM **TrustedHosts** seznamu.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-147">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="ce8ba-148">Upozorňujeme, že přidáte do seznamu TrustedHosts název serveru, který by se neměla považovat jako jakoukoli formu prohlášení o důvěryhodnost hostitelů sami – jsou jako ověřovací protokol NTLM nemůže zaručit, že je ve skutečnosti připojení k hostiteli hodláte připojit k.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-148">Please note that adding a server name to the TrustedHosts list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span>
<span data-ttu-id="ce8ba-149">Místo toho byste měli zvážit nastavení TrustedHosts být seznamu hostitelů, pro které chcete potlačit chybě, tím, že nelze ověřit identitu serveru.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-149">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>


### <a name="ongoing-communication"></a><span data-ttu-id="ce8ba-150">Probíhající komunikace</span><span class="sxs-lookup"><span data-stu-id="ce8ba-150">Ongoing Communication</span></span>

<span data-ttu-id="ce8ba-151">Po dokončení počáteční ověřování [protokol vzdálenou komunikaci prostředí PowerShell](https://msdn.microsoft.com/library/dd357801.aspx) šifruje všechny probíhající komunikaci symetrickým klíčem relace AES 256.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-151">Once initial authentication is complete, the [PowerShell Remoting Protocol](https://msdn.microsoft.com/library/dd357801.aspx) encrypts all ongoing communication with a per-session AES-256 symmetric key.</span></span>


## <a name="making-the-second-hop"></a><span data-ttu-id="ce8ba-152">Vytváření druhé směrování</span><span class="sxs-lookup"><span data-stu-id="ce8ba-152">Making the second hop</span></span>

<span data-ttu-id="ce8ba-153">Ve výchozím nastavení použije vzdálenou komunikaci prostředí PowerShell (Pokud je k dispozici) pomocí protokolu Kerberos nebo NTLM pro ověření.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-153">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="ce8ba-154">Obě tyto protokoly ověřování ke vzdálenému počítači bez odeslání přihlašovacích údajů k němu.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-154">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span>
<span data-ttu-id="ce8ba-155">Toto je nejbezpečnější způsob ověření, ale protože vzdálený počítač nemá přihlašovacích údajů uživatele, nemůže přistupovat k jiným počítačům a službám jménem uživatele.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-155">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span>
<span data-ttu-id="ce8ba-156">To se označuje jako "druhý směrování problém".</span><span class="sxs-lookup"><span data-stu-id="ce8ba-156">This is known as the "second hop problem".</span></span>

<span data-ttu-id="ce8ba-157">K tomuto problému nedošlo několika způsoby.</span><span class="sxs-lookup"><span data-stu-id="ce8ba-157">There are several ways to avoid this problem.</span></span> <span data-ttu-id="ce8ba-158">Popis těchto metod a výhody a nevýhody jednotlivých najdete v tématu [provedení připojení přes další počítač v vzdálenou komunikaci prostředí PowerShell](PS-remoting-second-hop.md).</span><span class="sxs-lookup"><span data-stu-id="ce8ba-158">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>